{% extends "base.html" %}

{% block extra_css %}
<style>
    .screen-display {
        height: 60px; background: linear-gradient(to bottom, #fff, transparent);
        opacity: 0.3; transform: perspective(500px) rotateX(-10deg);
        margin-bottom: 30px; width: 80%; margin-left: auto; margin-right: auto;
    }
    .seat-cb { display: none; }
    .seat-lbl {
        width: 40px; height: 40px; margin: 3px; background: #333;
        border-radius: 6px; cursor: pointer; display: flex;
        align-items: center; justify-content: center; font-size: 12px;
        color: #aaa; transition: 0.2s; border-bottom: 2px solid #222;
    }
    .seat-lbl.vip { border: 1px solid #ffc107; color: #ffc107; }
    .seat-lbl.couple { background: #9c27b0; color: #fff; width: 50px; }
    .seat-lbl.occupied { background: #111; color: #333; cursor: not-allowed; border: none; }

    .seat-cb:checked + .seat-lbl {
        background: #e50914 !important; color: white !important;
        transform: scale(1.1); border-color: #e50914 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card bg-dark border-secondary p-4 sticky-top" style="top: 100px;">
            <img src="{{ showtime.movie.poster.url }}" class="img-fluid rounded mb-3" style="max-height: 200px; object-fit: cover;">
            <h3 class="text-danger fw-bold">{{ showtime.movie.title }}</h3>
            <p class="mb-1 text-white"><i class="fas fa-map-marker-alt me-2"></i>{{ showtime.screen.cinema.name }}</p>
            <p class="mb-1 text-white"><i class="fas fa-tv me-2"></i>Phòng: {{ showtime.screen.name }}</p>
            <p class="mb-3 text-warning fw-bold fs-5"><i class="far fa-clock me-2"></i>{{ showtime.start_time|date:"H:i - d/m/Y" }}</p>

            <hr class="border-secondary">

            <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Ghế chọn:</span>
                <span id="seat-names" class="fw-bold text-white text-end">...</span>
            </div>
            <div class="d-flex justify-content-between mb-4">
                <span class="text-muted">Tạm tính:</span>
                <span id="total-price" class="fw-bold text-danger fs-4">0 đ</span>
            </div>

            {% if user.is_authenticated %}
                <button type="submit" form="booking-form" id="btn-pay" class="btn btn-danger w-100 py-3 fw-bold shadow" disabled>
                    XÁC NHẬN ĐẶT VÉ
                </button>
            {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-warning w-100">
                    Đăng nhập để đặt vé
                </a>
            {% endif %}
        </div>
    </div>

    <div class="col-md-8">
        <div class="card bg-dark border-secondary p-4">
            <div class="text-center mb-4">
                <div class="screen-display"></div>
                <small class="text-muted">MÀN HÌNH CHIẾU</small>
            </div>

            <form id="booking-form" method="POST" action="{% url 'book_tickets' showtime.id %}">
                {% csrf_token %}
                <div class="d-flex flex-column align-items-center overflow-auto">
                    {% regroup all_seats by row as seat_rows %}
                    {% for row in seat_rows %}
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-3 text-muted fw-bold" style="width: 20px;">{{ row.grouper }}</span>
                        {% for seat in row.list %}
                            {% if seat.id in occupied_seats %}
                                <div class="seat-lbl occupied">{{ seat.number }}</div>
                            {% else %}
                                <input type="checkbox" name="selected_seats" value="{{ seat.id }}"
                                       id="s-{{ seat.id }}" class="seat-cb"
                                       data-name="{{ row.grouper }}{{ seat.number }}"
                                       data-type="{{ seat.seat_type }}">
                                <label for="s-{{ seat.id }}" class="seat-lbl {{ seat.seat_type|lower }}">
                                    {{ seat.number }}
                                </label>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </form>

            <div class="d-flex justify-content-center gap-4 mt-5 flex-wrap">
                <div class="d-flex align-items-center"><span class="seat-lbl me-2" style="cursor: default;"></span> Thường</div>
                <div class="d-flex align-items-center"><span class="seat-lbl vip me-2" style="cursor: default;"></span> VIP</div>
                <div class="d-flex align-items-center"><span class="seat-lbl couple me-2" style="cursor: default;"></span> Đôi</div>
                <div class="d-flex align-items-center"><span class="seat-lbl occupied me-2" style="cursor: default;"></span> Đã bán</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function(){
        const cbs = document.querySelectorAll('.seat-cb');
        const priceEl = document.getElementById('total-price');
        const nameEl = document.getElementById('seat-names');
        const btn = document.getElementById('btn-pay');
        const base = {{ showtime.base_price|stringformat:"d" }};

        function update(){
            let total=0; let names=[];
            cbs.forEach(cb=>{
                if(cb.checked){
                    let p = base;
                    if(cb.dataset.type=='VIP') p+=10000;
                    if(cb.dataset.type=='COUPLE') p+=20000;
                    total+=p;
                    names.push(cb.dataset.name);
                }
            });
            priceEl.innerText = total.toLocaleString('vi')+' đ';
            if(names.length){
                nameEl.innerText = names.join(', ');
                if(btn) btn.disabled=false;
            } else {
                nameEl.innerText = '...';
                if(btn) btn.disabled=true;
            }
        }
        cbs.forEach(cb=>cb.addEventListener('change', update));
    });
</script>
{% endblock %}