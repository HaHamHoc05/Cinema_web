{% extends "base.html" %}

{% block extra_css %}
<style>
    /* 3D Screen */
    .screen-container { perspective: 1000px; margin-bottom: 50px; text-align: center; }
    .screen-display {
        background: linear-gradient(to bottom, #fff, rgba(255,255,255,0));
        height: 80px; width: 100%; max-width: 600px; margin: 0 auto;
        transform: rotateX(-15deg) scale(0.9);
        box-shadow: 0 50px 40px -20px rgba(255, 255, 255, 0.4);
        border-radius: 50% 50% 0 0 / 20px 20px 0 0; opacity: 0.8;
    }
    .screen-text { font-size: 0.8rem; letter-spacing: 4px; color: #888; margin-top: 15px; display: block; }

    /* Ghế ngồi */
    .seat-checkbox { display: none; }

    .seat-label {
        width: 40px; height: 40px;
        background-color: #444; border-radius: 8px 8px 12px 12px;
        margin: 4px; display: flex; align-items: center; justify-content: center;
        font-size: 11px; color: #ccc; cursor: pointer; transition: 0.2s;
        border-bottom: 3px solid #222; user-select: none; font-weight: 600;
    }

    /* Loại ghế */
    .seat-label.vip { border: 1px solid #ffd700; color: #ffd700; box-shadow: inset 0 0 5px rgba(255, 215, 0, 0.2); }
    .seat-label.couple { background-color: #9c27b0; border-bottom-color: #6a1b9a; color: white; width: 46px; }

    /* Trạng thái */
    .seat-label:hover:not(.occupied) { transform: scale(1.15); filter: brightness(1.2); z-index: 5; }
    .seat-checkbox:checked + .seat-label {
        background-color: var(--primary-red) !important; color: #fff !important;
        border-color: var(--primary-red) !important; box-shadow: 0 0 15px rgba(229, 9, 20, 0.8);
        transform: scale(1.1); z-index: 10;
    }
    .seat-label.occupied { background-color: #222 !important; color: #444; border-color: #333 !important; cursor: not-allowed; }

    .seat-map-wrapper { overflow-x: auto; padding-bottom: 20px; white-space: nowrap; }
    .booking-sidebar { position: sticky; top: 90px; }

    /* Chú thích */
    .legend-item { display: flex; align-items: center; font-size: 0.85rem; color: #ccc; margin-right: 15px; }
    .legend-box { width: 20px; height: 20px; margin-right: 8px; border-radius: 4px; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-4 mb-4 order-lg-1 order-2">
        <div class="booking-sidebar">
            <div class="card bg-dark border border-secondary shadow-lg overflow-hidden">
                <div class="position-relative">
                    <img src="{{ showtime.movie.poster.url }}" class="w-100" style="height: 200px; object-fit: cover; opacity: 0.5;" alt="">
                    <div class="position-absolute bottom-0 start-0 p-3 w-100" style="background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);">
                        <h4 class="fw-bold text-white mb-0">{{ showtime.movie.title }}</h4>
                    </div>
                </div>

                <div class="card-body">
                    <ul class="list-unstyled text-light small mb-4">
                        <li class="mb-2 d-flex justify-content-between"><span>Rạp:</span> <span class="fw-bold text-white">{{ showtime.screen.cinema.name }}</span></li>
                        <li class="mb-2 d-flex justify-content-between"><span>Phòng:</span> <span class="fw-bold text-white">{{ showtime.screen.name }}</span></li>
                        <li class="mb-2 d-flex justify-content-between"><span>Suất:</span> <span class="fw-bold text-danger">{{ showtime.start_time|date:"H:i - d/m/Y" }}</span></li>
                    </ul>
                    <hr class="border-secondary">

                    <div class="mb-3">
                        <span class="text-muted d-block mb-1">Ghế đang chọn:</span>
                        <div id="seat-list" class="fw-bold text-danger fs-5 text-break">
                            <span class="text-muted small fw-normal">Chưa chọn ghế</span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center bg-black p-3 rounded border border-secondary">
                        <span class="text-white">TỔNG CỘNG:</span>
                        <span id="total-price" class="fs-4 fw-bold text-warning">0 đ</span>
                    </div>
                </div>
            </div>

            {% if user.is_authenticated %}
                <button type="submit" form="booking-form" id="btn-submit" class="btn btn-danger w-100 btn-lg mt-3 fw-bold py-3 shadow-lg" disabled>
                    ĐẶT VÉ NGAY
                </button>
            {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-warning w-100 btn-lg mt-3 fw-bold">Đăng nhập để đặt vé</a>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-8 order-lg-2 order-1">
        <div class="card bg-dark border border-secondary p-4 h-100 shadow-sm">
            {% if user.is_authenticated %}
                <div class="screen-container">
                    <div class="screen-display"></div>
                    <span class="screen-text">MÀN HÌNH</span>
                </div>

                <form method="POST" action="{% url 'book_tickets' showtime.id %}" id="booking-form">
                    {% csrf_token %}
                    <div class="seat-map-wrapper d-flex flex-column align-items-center">
                        {% regroup all_seats by row as seat_rows %}
                        {% for row in seat_rows %}
                        <div class="d-flex mb-2 align-items-center">
                            <span class="text-muted fw-bold me-3 text-center" style="width: 25px;">{{ row.grouper }}</span>
                            {% for seat in row.list %}
                                {% if seat.id in occupied_seats %}
                                    <label class="seat-label occupied {{ seat.seat_type|lower }}" title="Đã bán">{{ seat.number }}</label>
                                {% else %}
                                    <input type="checkbox" name="selected_seats" value="{{ seat.id }}"
                                           id="seat-{{ seat.id }}" class="seat-checkbox"
                                           data-name="{{ row.grouper }}{{ seat.number }}"
                                           data-type="{{ seat.seat_type }}">
                                    <label for="seat-{{ seat.id }}" class="seat-label {{ seat.seat_type|lower }}">{{ seat.number }}</label>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </form>

                <div class="d-flex justify-content-center flex-wrap mt-5 pt-3 border-top border-secondary gap-3">
                    <div class="legend-item"><div class="legend-box" style="background: #444;"></div> Thường</div>
                    <div class="legend-item"><div class="legend-box" style="border: 1px solid #ffd700; color: #ffd700;"></div> VIP</div>
                    <div class="legend-item"><div class="legend-box" style="background: #9c27b0;"></div> Đôi</div>
                    <div class="legend-item"><div class="legend-box" style="background: #222; border: 1px solid #333;"></div> Đã bán</div>
                    <div class="legend-item"><div class="legend-box" style="background: var(--primary-red);"></div> Đang chọn</div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-lock fa-4x text-muted mb-3 opacity-50"></i>
                    <h5 class="text-muted">Vui lòng đăng nhập để xem sơ đồ ghế</h5>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.seat-checkbox');
        const totalPriceEl = document.getElementById('total-price');
        const seatListEl = document.getElementById('seat-list');
        const btnSubmit = document.getElementById('btn-submit');

        // Giá gốc từ server
        const basePrice = {{ showtime.base_price }};

        function updateSummary() {
            let total = 0;
            let selectedSeats = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    let price = basePrice;
                    const type = cb.dataset.type; // Lấy loại ghế từ data attribute

                    // Logic cộng tiền ghế VIP/Đôi
                    if (type === 'VIP') price += 10000;
                    if (type === 'COUPLE') price += 20000;

                    total += price;
                    selectedSeats.push(cb.dataset.name); // Lấy tên ghế (A1, A2)
                }
            });

            // Cập nhật giao diện
            totalPriceEl.textContent = total.toLocaleString('vi-VN') + ' đ';

            if (selectedSeats.length > 0) {
                seatListEl.textContent = selectedSeats.join(', ');
                seatListEl.classList.remove('text-muted', 'fw-normal', 'small');
                if(btnSubmit) btnSubmit.removeAttribute('disabled'); // Mở khóa nút
            } else {
                seatListEl.innerHTML = '<span class="text-muted small fw-normal">Chưa chọn ghế</span>';
                if(btnSubmit) btnSubmit.setAttribute('disabled', 'true'); // Khóa nút
            }
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateSummary));
    });
</script>
{% endblock %}