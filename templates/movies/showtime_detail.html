{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Hiệu ứng màn hình chiếu 3D toả sáng */
    .screen-container {
        perspective: 1000px;
        margin-bottom: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .screen-display {
        background: linear-gradient(to bottom, #fff, rgba(255,255,255,0));
        height: 60px;
        width: 100%;
        max-width: 600px;
        transform: rotateX(-30deg) scale(0.9);
        box-shadow: 0 30px 50px -10px rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        opacity: 0.8;
        margin-bottom: 20px;
    }
    .screen-text {
        color: #777;
        font-size: 0.8rem;
        letter-spacing: 2px;
        margin-top: 10px;
    }

    /* Style ghế ngồi */
    .seat-checkbox { display: none; }

    .seat-label {
        width: 35px;
        height: 35px;
        border-radius: 8px 8px 12px 12px; /* Dáng ghế */
        background-color: #3a3a3a;
        margin: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #aaa;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 3px solid #222; /* Chân ghế */
    }

    .seat-label:hover {
        background-color: #666;
        color: #fff;
        transform: translateY(-2px);
    }

    /* Ghế đang chọn */
    .seat-checkbox:checked + .seat-label {
        background-color: var(--primary-red);
        color: #fff;
        box-shadow: 0 0 15px rgba(220, 7, 20, 0.6);
        border-bottom-color: #800000;
        transform: scale(1.1);
    }

    /* Ghế đã đặt */
    .seat-label.occupied {
        background-color: #1a1a1a;
        color: #333;
        border: 1px solid #333;
        cursor: not-allowed;
        box-shadow: inset 0 0 5px #000;
    }

    .seat-row { display: flex; justify-content: center; align-items: center; margin-bottom: 8px; }

    /* Sticky Sidebar */
    .booking-sidebar {
        position: sticky;
        top: 100px; /* Cách top navbar */
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="booking-sidebar">
            <div class="card bg-dark border border-secondary shadow-lg">
                <img src="{{ showtime.movie.poster.url }}" class="card-img-top opacity-50" style="height: 200px; object-fit: cover;" alt="">
                <div class="card-body">
                    <h3 class="card-title text-danger fw-bold mb-3">{{ showtime.movie.title }}</h3>
                    <ul class="list-unstyled text-light">
                        <li class="mb-2"><i class="fas fa-map-marker-alt text-muted me-2"></i> {{ showtime.screen.cinema.name }}</li>
                        <li class="mb-2"><i class="fas fa-tv text-muted me-2"></i> Phòng {{ showtime.screen.name }}</li>
                        <li class="mb-2"><i class="far fa-clock text-muted me-2"></i> {{ showtime.start_time|date:"H:i - d/m/Y" }}</li>
                    </ul>
                    <hr class="border-secondary">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Ghế đang chọn:</span>
                        <span id="seat-count" class="fw-bold">0</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fs-5">Tạm tính:</span>
                        <span id="total-price" class="fs-4 text-danger fw-bold">0 đ</span>
                    </div>
                </div>
            </div>

            {% if user.is_authenticated %}
                <button type="submit" form="booking-form" class="btn btn-danger w-100 btn-lg mt-3 fw-bold shadow-lg">
                    <i class="fas fa-ticket-alt me-2"></i> ĐẶT VÉ NGAY
                </button>
            {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-warning w-100 btn-lg mt-3 fw-bold">
                    <i class="fas fa-sign-in-alt me-2"></i> Đăng nhập để đặt vé
                </a>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card bg-dark border border-secondary p-4 h-100">
            <h4 class="text-center text-uppercase mb-4 border-bottom border-secondary pb-3">Chọn vị trí ngồi</h4>

            {% if user.is_authenticated %}
                <div class="screen-container">
                    <div class="screen-display"></div>
                    <span class="screen-text">MÀN HÌNH</span>
                </div>

                <form method="POST" action="{% url 'book_tickets' showtime.id %}" id="booking-form">
                    {% csrf_token %}
                    <div class="d-flex flex-column align-items-center overflow-auto py-3">
                        {% regroup all_seats by row as seat_rows %}

                        {% for row in seat_rows %}
                        <div class="seat-row">
                            <span class="text-muted fw-bold me-3" style="width: 20px;">{{ row.grouper }}</span>
                            {% for seat in row.list %}
                                {% if seat.id in occupied_seats %}
                                    <label class="seat-label occupied" title="Đã có người đặt">{{ seat.number }}</label>
                                {% else %}
                                    <input type="checkbox" name="selected_seats" value="{{ seat.id }}"
                                           id="seat-{{ seat.id }}" class="seat-checkbox"
                                           data-price="{{ showtime.base_price }}">
                                    <label for="seat-{{ seat.id }}" class="seat-label">{{ seat.number }}</label>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </form>

                <div class="d-flex justify-content-center mt-5 gap-4 small text-muted">
                    <div class="d-flex align-items-center">
                        <div class="seat-label me-2" style="width: 20px; height: 20px; cursor: default;"></div> Trống
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="seat-label me-2" style="background-color: var(--primary-red); width: 20px; height: 20px; cursor: default;"></div> Đang chọn
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="seat-label me-2 occupied" style="width: 20px; height: 20px; cursor: default;"></div> Đã bán
                    </div>
                </div>

            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-lock fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Vui lòng đăng nhập để xem sơ đồ ghế</h5>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.seat-checkbox');
        const totalPriceEl = document.getElementById('total-price');
        const seatCountEl = document.getElementById('seat-count');

        function updateSummary() {
            let total = 0;
            let count = 0;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    total += parseFloat(cb.dataset.price);
                    count++;
                }
            });
            totalPriceEl.textContent = total.toLocaleString('vi-VN') + ' đ';
            seatCountEl.textContent = count;
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateSummary));
    });
</script>
{% endblock %}