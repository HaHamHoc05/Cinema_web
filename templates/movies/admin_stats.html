{% extends "base.html" %}
{% load humanize %}  {% block content %}

<div class="container py-5">
    <h2 class="text-uppercase fw-bold text-danger mb-4 text-center">
        <i class="fas fa-chart-line me-2"></i>Thống Kê & Dự Báo
    </h2>

    <div class="card bg-dark border-secondary mb-4 shadow-sm">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="text-secondary small fw-bold mb-1">Năm</label>
                    <select name="year" class="form-select bg-secondary text-white border-0">
                        {% for y in years_list %}
                            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="text-secondary small fw-bold mb-1">Quý</label>
                    <select name="quarter" class="form-select bg-secondary text-white border-0">
                        <option value="">-- Cả năm --</option>
                        <option value="1" {% if selected_quarter == 1 %}selected{% endif %}>Quý 1</option>
                        <option value="2" {% if selected_quarter == 2 %}selected{% endif %}>Quý 2</option>
                        <option value="3" {% if selected_quarter == 3 %}selected{% endif %}>Quý 3</option>
                        <option value="4" {% if selected_quarter == 4 %}selected{% endif %}>Quý 4</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="text-secondary small fw-bold mb-1">Tháng</label>
                    <select name="month" class="form-select bg-secondary text-white border-0">
                        <option value="">-- Tất cả --</option>
                        {% for m in "123456789012"|make_list %}
                            {% if forloop.counter <= 12 %}
                            <option value="{{ forloop.counter }}" {% if selected_month == forloop.counter %}selected{% endif %}>Tháng {{ forloop.counter }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="text-secondary small fw-bold mb-1">Ngày</label>
                    <input type="number" name="day" min="1" max="31" class="form-control bg-secondary text-white border-0" value="{{ selected_day }}" placeholder="Ngày...">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary-red w-100 fw-bold">
                        <i class="fas fa-filter me-1"></i> Lọc
                    </button>
                </div>
                <div class="col-md-2">
                    <a href="{% url 'admin_stats' %}" class="btn btn-outline-light w-100">Reset</a>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-body">
                    <h6 class="text-white text-uppercase small">Tổng Doanh Thu (Đã lọc)</h6>
                    <h2 class="fw-bold text-success mt-2">{{ total_revenue|intcomma }} đ</h2>
                    <span class="badge bg-secondary">{{ total_tickets }} vé đã bán</span>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card bg-dark border-info h-100" style="background: linear-gradient(45deg, #1a1a1a, #0f2b33);">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-info text-uppercase small fw-bold"><i class="fas fa-robot me-2"></i>Dự báo doanh thu tháng tới</h6>
                        <h2 class="fw-bold text-white mt-2">{{ predicted_revenue|intcomma }} đ</h2>
                        <div class="small text-white">So với tháng hiện tại ({{ current_month_revenue|intcomma }} đ)</div>
                    </div>

                    <div class="text-end">
                        {% if growth_percent > 0 %}
                            <div class="fs-1 fw-bold text-success">
                                <i class="fas fa-arrow-up me-1"></i>{{ growth_percent }}%
                            </div>
                            <span class="text-success small fw-bold">TĂNG TRƯỞNG</span>
                        {% else %}
                            <div class="fs-1 fw-bold text-danger">
                                <i class="fas fa-arrow-down me-1"></i>{{ growth_percent }}%
                            </div>
                            <span class="text-danger small fw-bold">SUY GIẢM</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card bg-dark border-secondary shadow-lg">
                <div class="card-header border-secondary text-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-area me-2"></i>{{ chart_title }}</span>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary text-white fw-bold">Top Phim Theo Doanh Thu (Trong khoảng thời gian lọc)</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th class="ps-4">Tên Phim</th>
                                    <th class="text-center">Số Vé</th>
                                    <th class="text-end pe-4">Doanh Thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in movie_stats %}
                                <tr>
                                    <td class="ps-4 fw-bold text-warning">{{ item.showtime__movie__title }}</td>
                                    <td class="text-center">{{ item.ticket_count }}</td>
                                    <td class="text-end pe-4 fw-bold text-success">{{ item.revenue|intcomma }} đ</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-center text-white py-4">Không có dữ liệu.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('revenueChart').getContext('2d');

    // Gradient cho biểu đồ đẹp hơn
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(229, 9, 20, 0.6)'); // Đỏ đậm
    gradient.addColorStop(1, 'rgba(229, 9, 20, 0.0)'); // Trong suốt

    const revenueChart = new Chart(ctx, {
        type: 'line', // Chuyển sang biểu đồ đường
        data: {
            labels: {{ chart_labels|safe }}, // Dữ liệu trục X (Thời gian)
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: {{ chart_data|safe }}, // Dữ liệu trục Y (Tiền)
                borderColor: '#e50914',
                backgroundColor: gradient,
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#e50914',
                pointRadius: 5,
                pointHoverRadius: 8,
                fill: true, // Tô màu dưới đường
                tension: 0.4 // Làm mượt đường cong
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.raw);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#333' },
                    ticks: { color: '#ccc', callback: (val) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumSignificantDigits: 3 }).format(val) }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#ccc' }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
</script>
{% endblock %}